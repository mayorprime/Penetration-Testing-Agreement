# Objectives

In this lab, you will perform Reflected XSS and Stored XSS attacks
against the DVWA (Damn Vulnerable Web Application!) at low, medium, and
high security levels.

- Part 1: Perform Reflective Cross Site Scripting Exploits
- Part 2: Perform Stored Cross Site Scripting Exploits

\
**Background**

In this lab, we will perform penetration tests of a web application to
determine if it has been securely designed.

DVWA (Damn Vulnerable Web Application!) is a PHP/MySQL web application.
It is designed to be vulnerable to common attacks to allow security
professionals to test their skills and tools and students and teachers
to learn and understand web application security in a legal environment.

DVWA provides four levels of security: Low, Medium, High, and
Impossible. Each security level requires different skills to perform
exploits. The security levels reflect different levels of security that
developers may code into their applications. In this lab, you will
perform exploits against three of the security levels, Low, Medium, and
High, allowing you to adjust your attacks to compromise them.

# Resources

- Kali VM customized for the Ethical Hacker course
- Internet access

## Part 1: Perform Reflective Cross Site Scripting Exploits

A **Reflected XSS** attack is one in which a malicious script is
reflected off a web server to the user\'s browser. The script is
activated through a link that the victim clicks. This will send a
request to the website that has a vulnerability that enables execution
of the malicious script.

### Step 1: Log into DVWA.

a.  From the Kali Linux VM, open a browser and navigate to the DVWA
    application.
b.  Enter the following URL into the
    browser [http://10.6.6.13](http://10.6.6.13/).
c.  At the login prompt, enter the credentials: **admin**/**password**.

![](Pictures/100000000000077D0000039FA5DC6465.png){width="16.603cm"
height="8.027cm"}

### Step 2: Perform a Reflected XSS attack at Low security level.

a.  Select **DVWA Security** in the left menu and select **Low** in the
    Security Level dropdown. Click **Submit**.

    ![](Pictures/10000000000005510000036DE71F95D3.png){width="16.249cm"
    height="9.894cm"}

b.  Select **XSS (Reflected)** from the left menu.

![](Pictures/10000000000005E40000037CB411388D.png){width="17cm"
height="10.054cm"}

c.  Type the string **Reflected_Test** in the **What\'s your name?** box
    and click **Submit**.

    ![](Pictures/10000000000005A60000035E8102ECCD.png){width="16.249cm"
    height="9.686cm"}

> You will see the message **Hello Reflected_Test** appear.

d.  Enter **CTRL+U** on the keyboard to view the source code of the
    page.

e.  Search for the string **Hello Reflected_Test** by entering CTRL+F to
    open a search box.

    ![](Pictures/100000000000077F000003805D5F79A0.png){width="16.249cm"
    height="8.144cm"}

> The presence of the string in the page source HTML indicates that
> values entered in a user response text field are inserted into the
> source code for the page. This indicates to an attacker that the page
> may be vulnerable to reflected XSS attacks.

f.  Close the source code window and return to the Reflected XSS
    Vulnerability page.
g.  Enter the following payload in the **What's your name?** box and
    click **Submit**.

> **\<script\>alert(\"You are hacked!\")\</script\>**

> ![](Pictures/100000000000054000000284B9D199FB.png){width="14.46cm"
> height="6.927cm"} ****

> ![](Pictures/10000000000005190000036234742A9C.png){width="14.46cm"
> height="9.594cm"}

> An alert popup box will appear with the words **You are hacked!**.
> This means the site is vulnerable to Reflected XSS attacks and we have
> successfully exploited the vulnerability.

> ![](Pictures/10000000000006230000037B1CC1EBB9.png){width="15.942cm"
> height="9.042cm"}

h.  Select and copy the URL for the compromised page. Open a new browser
    tab and paste the URL into the URL field and press \<Enter\>.

> You should see the same web page appear displaying the **You are
> hacked**! popup box. This means that if a user opens the URL a
> malicious script will execute. The alert box is used to simulate a
> malicious script in this lab.

> In an ethical hacking engagement, you would try inserting a simple
> test script into input fields to see if the script executes. If so,
> the website is vulnerable to reflected XSS attacks. You could then
> distribute the link in a phishing attack to determine the level of
> security awareness among your customers' employees.

### Step 3: Perform a Reflected XSS attack at Medium security level.

We will attempt the same attack, but this time the security level of the
Web site will Medium.

1.  Select **DVWA Security** in the left menu and select **Medium** in
    the Security Level dropdown. Click **Submit**.

    ![](Pictures/10000000000004B70000033B4A92B831.png){width="17cm"
    height="11.647cm"}

2.  Select **XSS (Reflected)** in the left menu.

3.  Again, enter the following payload in the **What\'s your name?** box
    and click **Submit**.

**\<script\>alert(\"You are hacked!\")\</script\>**

![](Pictures/1000000000000535000003758C4CDEE0.png){width="17cm"
height="11.287cm"}

You will see a Hello response, but this time no pop up will appear. This
indicates that the script did not execute. Note that the script is
displayed as literal text.

![](Pictures/100000000000053400000373E3CAB4E0.png){width="17cm"
height="11.268cm"}

We can analyze the code in the backend of the web site to investigate
the reason.

4.  Click the **View Source** button on the bottom right of the page and
    review the PHP code.

![](Pictures/10000000000005130000037C1E4CAF0D.png){width="17cm"
height="11.673cm"}

**Note**: On a real web server, we would not have access to this backend
source code, but here on DVWS we do.

5.  Note the line:

**\$name = str_replace ( \'\<script\>\', \'\', \$\_GET\[ \'name\' \]
);**

![](Pictures/10000000000004DD000003856B3ED1DC.png){width="17cm"
height="12.301cm"}

This source code creates a filter, with **str_replace()** function, that
removes the **\<script\>** tag in our payload and replaces it with a
null value. This renders the payload script ineffective, so the attack
failed, and no popup window is displayed. Because this script is only
filtering out \<script\> in lower case, we can try and get around the
filter by using a different tag in the payload. We will use
**\<ScRipt\>**.

6.  Close the source code window and return to the Reflected XSS
    Vulnerability page.
7.  Enter the following payload in the **What\'s your name?** box and
    click **Submit**.

**\<ScRipt\>alert(\"You are hacked!\")\</ScRipt\>**

![](Pictures/1000000000000565000003800BEFB5E3.png){width="17cm"
height="11.028cm"}

> An alert popup box will appear with the words **You are hacked!**.
> This means the site is vulnerable to Reflected XSS attacks and we have
> successfully exploited the vulnerability.

![](Pictures/10000000000005D90000036CF810C25D.png){width="17cm"
height="9.948cm"}

### Step 4: Perform a Reflective XSS attack at High security level.

The same attack will be attempted, but this time the security level of
the website will be High.

1.  Select **DVWA Security** in the left menu and select **High** in the
    Security Level dropdown. Click **Submit**.

    ![](Pictures/10000000000004A800000340E0694DD5.png){width="17cm"
    height="11.866cm"}

2.  Select **XSS (Reflected)** in the left menu.

3.  Enter the following payload in the **What\'s your name?** box and
    click **Submit**. (Note the use of underscores to replace spaces.)

**\<ScRipt\>alert(\"You_are_hacked!\")\</ScRipt\>**

![](Pictures/100000000000051C0000038B42E40599.png){width="17cm"
height="11.786cm"}

There is a Hello message and no alert pop up box. Again, we can analyze
the backend source code to investigate.

![](Pictures/100000000000054E0000037F09294D2F.png){width="17cm"
height="11.202cm"}

4.  Click the **View Source** button and review the PHP code.

Note the following line:

**\$name = preg_replace( \'/\<(.\*)s(.\*)c(.\*)r(.\*)i(.\*)p(.\*)t/i\',
\'\', \$\_GET\[ \'name\' \] );**

![](Pictures/100000000000055600000374DDDD3B61.png){width="17cm"
height="11cm"}

In this code, the developer used a regular expression to replace any
form of the **\<script\>** tag, no matter what case of the characters is
used, with a null value.

5.  To bypass this filter, we must use another HTML tag instead of
    **\<script\>** to attack the site.

Close the source code window and return to the Reflected XSS
Vulnerability page.

6.  Enter the following payload in the **What\'s your name?** box and
    click **Submit**. (Note the use of underscores to replace spaces.)

**\<img src=x onerror=alert(\"You_are_hacked!\")\>**

![](Pictures/10000000000004E60000037E59EFC0F7.png){width="17cm"
height="12.12cm"}

The XSS popup box will appear this time. We successfully bypassed the
filter and exploited the Reflected XSS vulnerability in DVWA at High
level security.

![](Pictures/10000000000005B0000003724BF43B3E.png){width="17cm"
height="10.298cm"}

## Part 2: Perform Stored Cross Site Scripting Exploits

With the **stored XSS** exploit, you enter a malicious script through
user input and the script is stored on the target server in a message
forum, database, visitor log, or comment field. When a user visits the
target, the server exposes the user to the malicious code.

### Step 1: Perform a Stored XSS attack at Low security level.

Exploiting stored XSS at low level security is easy because there are no
security measures in place. You can simply submit a \<script\> to
achieve the exploit.

a.  Select **DVWA Security** in the left menu and select **Low** in the
    Security Level dropdown. Click **Submit**.

    ![](Pictures/100000000000056E0000036EB0955D8D.png){width="16.249cm"
    height="10.262cm"}

b.  Select **XSS (Stored)** in the left menu.

c.  Type the string **XSS Test#1** in the **Name\*** field and
    type **Stored XSS Test** in the **Message \*** field. click **Sign
    Guestbook**.

![](Pictures/100000000000052100000302D0341FA5.png){width="16.249cm"
height="9.527cm"}

![](Pictures/10000000000004080000016FC6D92D12.png){width="17cm"
height="6.045cm"}

d.  Enter **CTRL+U** on the keyboard to view the page source code.
    Enter **CTRL+F** to search for the **Test#1 **and **Stored XSS
    Test** strings.

> Both strings, **Test#1** and **Stored XSS Test**, will be in the page
> source code indicating that the two input fields may be vulnerable to
> a Stored XSS attack.

> ![](Pictures/1000000000000647000003A1DCA1678D.png){width="15.942cm"
> height="9.216cm"}

> 

e.  Close the source code window and return to the Stored XSS
    Vulnerability page.
f.  Enter **Test#1** in the **Name \*** box and enter the following
    payload in the **Message \*** field and click **Sign Guestbook**.

> **\<script\>alert(\"You are hacked!\")\</script\>**

> ![](Pictures/100000000000055F0000026075630655.png){width="15.73cm"
> height="6.955cm"}

> 

> An XSS alert popup box will appear with the words **You are hacked!**.
> This means the site was vulnerable to stored XSS attacks and we have
> successfully exploited the vulnerability.

> ![](Pictures/10000000000005B8000002DCD22F1661.png){width="15.73cm"
> height="7.865cm"}

g.  Refresh the page. If alerted, click **Resend** to display the page.
    The XSS alert popup box will appear again.

> Because the XSS payload is stored in the guestbook, the alert popup
> box will appear each time the page is refreshed.

h.  Before proceeding to the next step, clear the XSS payload from the
    page. Click**** **Setup / Reset DB** in the left menu then
    click **Create / Reset Database**.

### Step 2: Perform a Stored XSS attack at Medium security level.

The same attack will be attempted, but this time the security level of
the Web site will be changed to Medium.

Exploiting reflected XSS at medium level security is not difficult.
Using \<script\> will be rejected but changing it to a different case
such as \<ScRipt\> will bypass the security and achieve the exploit.

1.  Select **DVWA Security** in the left menu and select **Medium** in
    the Security Level options dropdown. Click **Submit**.

    ![](Pictures/100000000000059900000366BAADD480.png){width="17cm"
    height="10.321cm"}

2.  Select **XSS (Stored)** in the left menu.

3.  Type the string **XSS Test#2** in the **Name\*** field and type
    **Stored XSS Test** in the **Message \*** field. Click **Sign
    Guestbook**.

4.  Enter **CTRL+U** on the keyboard to view the page source code. Enter
    **CTRL+F** to search for the **Test#2** and **Stored XSS Test**
    strings.

Both strings will be in the page source code indicating that the two
input fields may be vulnerable to a Stored XSS attack.

![](Pictures/10000000000006210000039689CD8406.png){width="17cm"
height="9.947cm"}

5.  Close the source code window and return to the Vulnerability page.
6.  Enter **XSS Test#2** in the **Name \*** box and enter the following
    payload in the **Message \*** box and click **Sign Guestbook**.

**\<script\>alert(\"You are hacked!\")\</script\>**

![](Pictures/10000000000005BA0000037673BB18D8.png){width="17cm"
height="10.273cm"}

No popup box should appear. Refreshing the page should not cause the
alert popup box to appear either.

![](Pictures/10000000000004E800000359170D3C9F.png){width="17cm"
height="11.599cm"}

This means that there is code in the backend that is sanitizing the user
input from the **Message \*** field to prevent scripts from being
submitted. You can see the modified input in the last rectangle message
box below the input fields.

7.  Click the **View Source** button and review the PHP source code and
    investigate.

You will see two blocks of code with the word **Sanitize**. The first
block of code, under **// Sanitize message input**, contains two PHP
functions for performing input sanitization. The **strip_tags()**
function removes all html tags from the message field before storing
them in the database. The **htmlspecialchars()** function converts all
special characters into equivalent HTML entities so they are not
reflected back in the browser.

![](Pictures/10000000000005A60000037A22C175C5.png){width="17cm"
height="10.462cm"}

The second block of code, under **// Sanitize name input**, performs
input sanitation on the **Name \*** field. It contains the
**str_replace()** function which replaces any occurrence of the
**\<script\>** tag with a null value. This disables the script
completely.

We can attempt to bypass the security on the **Name \*** field by using
some other payload that does not contain **\<script\>** tags.

8.  Close the source code window.

9.  Before entering any payload into the **Name \*** field, the max
    character length restriction of 10 characters on the field must be
    increased. This is a client-side setting so it is easy to change
    with the following steps:

    1.  Right-click in the **Name \*** field and select **Inspect**.
        This opens the Web Developer Tools window and displays the page
        source code.

    2.  Find and double-click **maxlength** in the page source and
        change it from **10** to **100**. The maxlength property is
        inside the \<input\> tag for the text field.

    3.  Press **Enter** on the keyboard to apply the changes.

    4.  Close the Web Developer's Tools ********Window.

        ![](Pictures/1000000000000640000003D70B334C5E.png){width="17cm"
        height="10.444cm"}

With the **maxlength** restriction changed, the XSS payload can now be
entered into the **Name \*** field.

**Note**: Changing the **maxlength** parameter does not persist. If you
refresh the page, for example, the setting needs to be changed again.

10. Return to the Vulnerability page and enter the following payload in
    the **Name \*** field.

**\<ScRipt\>alert(\"You are hacked!\")\</ScRipt\>**

11. In the **Message \*** field you can type any text you like and then
    click **Sign Guestbook**.

    ![](Pictures/10000000000005C80000037D96991C55.png){width="17cm"
    height="10.257cm"}

An XSS alert popup box will appear with the words **You are hacked!**.

![](Pictures/10000000000005A70000038E4D910F29.png){width="17cm"
height="10.691cm"}

Because the XSS payload is stored in the guestbook, the alert popup box
will appear each time the page is refreshed or each time other users
visit the page.

The popup confirms you have successfully exploited Stored XSS
vulnerability at the Medium level of security.

12. Before proceeding to the next step, clear the XSS payload from the
    page. Click ******Setup / Reset DB** in the left menu then click
    **Create / Reset Database**.

![](Pictures/100000000000057900000382A32938CC.png){width="17cm"
height="10.896cm"}

### Step 3: Perform a Stored XSS attack at High security level.

You will attempt the same attack, but this time the security level of
the Web site will be set to High.

At high level the security code whitelists \<scripts\> and all else is
rejected. However, other tags, such as svg will work.

a.  Select **DVWA Security** in the left menu and select **High** in the
    Security Level dropdown. Click **Submit**.

    ![](Pictures/100000000000055C0000037D5E44F6F5.png){width="16.249cm"
    height="10.576cm"}

b.  Select **XSS (Stored)** in the left menu.

c.  Type the string **XSS Test#3** in the **Name\*** field and
    type **Stored XSS Test** in the **Message \*** field. Click **Sign
    Guestbook**.

![](Pictures/100000000000054F00000377D186C78A.png){width="16.249cm"
height="10.605cm"}

![](Pictures/10000000000005DB00000379F12267A8.png){width="17cm"
height="10.081cm"}

d.  Enter **CTRL+U** on the keyboard to view the page source code.
    Enter **CTRL+F** to search for the **Test#3** and **XSS
    Test** strings.

> Both **Test#3** and **XSS Test** should be in the page source code
> indicating that the two input fields may be vulnerable to a Stored XSS
> attack.

> ![](Pictures/1000000000000629000003A5B9E07B4E.png){width="15.942cm"
> height="9.432cm"}

e.  Close the page source code tab and return to the Vulnerability page.
f.  Enter **XSS Test#3** in the **Name \*** box and enter the following
    payload in the **Message \*** box and click **Sign Guestbook**.

> **\<ScRipt\>alert(\"You are hacked!\")\</ScRipt\>**

> ![](Pictures/10000000000004F70000037511BFE61E.png){width="14.884cm"
> height="10.363cm"}

> No popup box will appear. Refreshing the page will not cause the alert
> popup box to appear either.

> This means that there is code in the site backend that is sanitizing
> the user input from the **Message \*** field.

> ![](Pictures/100000000000051C0000037D3E5566AD.png){width="15.942cm"
> height="10.883cm"}

g.  Click the **View Source** button and review the PHP source code and
    investigate.

> You will see two blocks of code. As before with the Medium security,
> the first block of code, under **// Sanitize message input**, contains
> two php functions for performing input sanitization.
> The **strip_tags()** function removes all html tags from the message
> field before storing them in the database.
> The **htmlspecialchars()** function converts all special characters
> into equivalent HTML characters so they are not reflected back in the
> browser.

> The second block of code, under **// Sanitize name input**, is
> performing input sanitation on the **Name \*** field. It contains
> the **preg_replace()** function. This function uses a regular
> expression to replace any occurrence of the **\<script\>** tag,
> regardless of character case, with a null value.

> ![](Pictures/1000000000000571000003996B70AC88.png){width="15.942cm"
> height="10.539cm"}

> We can attempt to bypass the security on the **Name \*** field by
> using some other payload that does not contain **\<script\>** tags.

h.  Before entering any payload into the **Name \*** field, it will be
    necessary to change the max character length restriction on the
    field, as was done above.
i.  ![](Pictures/10000000000006A2000003864396E4C2.png){width="16.249cm"
    height="8.631cm"}

> With the **maxlength** restriction changed, the XSS payload can now be
> entered into the **Name \*** field.

i.  Return to the Vulnerability page and enter the following payload in
    the **Name \*** field. (Note the use of underscores to replace
    spaces.)

> **\<svg onload=alert(\"You_are_hacked!\")\>**

j.  In the **Message \*** field, you can type any text you like and then
    click **Sign Guestbook**.

    ![](Pictures/10000000000005870000038EFEB1200B.png){width="16.249cm"
    height="10.449cm"}

> An XSS alert popup box will appear with the message
> \"**You_are_hacked!**\".

> ![](Pictures/100000000000077F000003A7F39D11D9.png){width="15.942cm"
> height="7.766cm"}

> Because the XSS payload is stored in the guestbook, the alert popup
> box will appear each time the page is refreshed.

> The popup confirms you have successfully exploited a Stored XSS
> vulnerability at High security level.

k.  Before proceeding to the next step, clear the XSS payload from the
    page. Click**** **Setup / Reset DB** in the left menu then
    click **Create / Reset Database**.

### Step 4: Perform a stored iframe exploit.

1.  Select **DVWA Security** in the left menu and select **Low** in the
    Security Level dropdown. Click **Submit**.

    ![](Pictures/100000000000065D000003818FF300BA.png){width="17cm"
    height="9.361cm"}

2.  Select **XSS (Stored)** in the left menu.

3.  Type the string **iframe** in the **Name\*** field and type the
    following message in the **Message \*** field. Click **Sign
    Guestbook**.

**\<iframe src=\"http://h4cker.org\"\>\</iframe\>**

![](Pictures/100000000000052F000001DB691004BE.png){width="17cm"
height="6.084cm"}

The H4cker website should now be displayed under the iframe test
message.

![](Pictures/100000000000069200000391785F1795.png){width="17cm"
height="9.227cm"}

This is a powerful exploit because the threat actor could send the
browser to a malicious website.

4.  Before proceeding to the next step, clear the XSS payload from the
    page. Click ******Setup / Reset DB** in the left menu then click
    **Create / Reset Database**.

### Step 5: Perform a stored cookie exploit.

Stealing the cookies of website visitors has security implications.
Cookies contain information about how and when users visit a web site
and sometimes authentication information, such as usernames and
passwords. Without proper security measures, a threat actor can capture
cookies and use them to impersonate specific users and gain access to
their information and accounts.

1.  Select **DVWA Security** in the left menu and select **Low** in the
    Security Level options dropdown. Click **Submit**.

    ![](Pictures/100000000000065D000003818FF300BA.png){width="17cm"
    height="9.361cm"}

2.  Select **XSS (Stored)** in the left menu.

3.  Type the string **cookie** in the **Name\*** field and type the
    following message in the **Message \*** field. Click **Sign
    Guestbook**.

**\<script\>alert(document.cookie)\</script\>**

![](Pictures/100000000000055E00000376F4716BEE.png){width="17cm"
height="10.963cm"}

A popup box with the cookie will be presented. This is a cookie that PHP
uses to keep of track of running sessions.

![](Pictures/100000000000076D000003A5D2033F97.png){width="17cm"
height="8.343cm"}

An exploit could modify the XSS script to have the cookie sent to
another destination rather than just displaying it.

4.  Click **OK** in the pop-up box.

    Using this same techniques, try to steal cookies at the medium and
    high security levels that you have learned in this lab.

FINDINGS

Web application has serious security vulnerabilities and there are
likely other vulnerabilities present. All web application should be
evaluated for more damaging vulnerabilities.
