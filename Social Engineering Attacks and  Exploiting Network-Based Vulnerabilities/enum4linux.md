# Background / Scenario {#background-scenario}

Poorly secured and managed Windows server networks are a huge security
risk. Penetration testers must uncover any vulnerabilities in file and
print sharing functions that can leave an organization vulnerable to
attack. In this activity, you will explore the capabilities of the
enum4linux tool to enumerate user and file sharing information from
Samba servers. Finally, you will use the smbclient utility to transfer
files between systems.

In this lab you will get familiar with a popular tool that is used to
discover network shares and other sensitive information through the
exploitation of SMB. You will also conduct a simulated exploit in which
you transfer an unauthorized and potentially malicious file to an
unprotected share.

# Required Resources

- Customized Kali Linux Vm for Ethical Hacker course
- Internet access

## Launch enum4linux and explore its capabilities. {#launch-enum4linux-and-explore-its-capabilities.}

Server Message Block (SMB) is a Microsoft protocol that is available on
non-Microsoft networks through the open-source Samba service. SMB makes
it easy to set up and access network shares on LANs.

TOPOLOGY

![](Pictures/10000000000003F30000027ECFC30E9F.png){width="17cm"
height="10.726cm"}

### Verify that enum4linux is installed and view the help file

Most enum4linux commands must be run as root, so use the **sudo su
**command to obtain persistent root access.

At the prompt, enter the command to view the enum4linux help file.

┌──(kali㉿kali)-\[\~\]

└─\$ **sudo su**

\[sudo\] password for kali:

┌──(root㉿kali)-\[/home/kali\]

└─# **enum4linux -help**

The help file contains the syntax and options available to enumerate
host and server information on networks that use SMB. Enum4linux
requires that Samba be installed on the host system, in this case the
Kali Linux computer, because it is dependent on the built-in Samba
utilities.

OUTPUT:

![](Pictures/10000000000004D600000237AC842EA0.png){width="17cm"
height="7.784cm"}

![](Pictures/100000000000050A000003367ABB5490.png){width="17cm"
height="10.832cm"}

Using **-U **with enum4linux to get the UserList

┌──(root㉿kali)-\[/home/kali\]

└─# **enum4linux -U 172.17.0.2**

OUTPUT:

![](Pictures/100000000000061F00000356A4912645.png){width="17cm"
height="9.264cm"}

![](Pictures/100000000000061E000003547226281D.png){width="17cm"
height="9.248cm"}

![](Pictures/100000000000058900000370AC200AB4.png){width="17cm"
height="10.557cm"}

Using **-S **with enum4linux to get the ShareList

┌──(root㉿kali)-\[/home/kali\]

└─# **enum4linux -S 172.17.0.2**

OUTPUT:

![](Pictures/10000000000006360000033E8D6EB770.png){width="17cm"
height="8.872cm"}

![](Pictures/10000000000005CB00000368385BD041.png){width="17cm"
height="9.994cm"}

Using **-Sv **with enum4linux

┌──(root㉿kali)-\[/home/kali\]

└─# **enum4linux -Sv 172.17.0.2**

****Note the \[V\]** **at the beginning of some of the lines of output.
The verbose mode provides a narrative of how the results were
obtained.****

**OUTPUT:**

![](Pictures/100000000000063C000003520C8C0029.png){width="17cm"
height="9.054cm"}** **

![](Pictures/100000000000064E0000035CEB59201D.png){width="17cm"
height="9.058cm"}** **

![](Pictures/10000000000006730000034DA19460CE.png){width="17cm"
height="8.7cm"}** **

![](Pictures/100000000000069D00000353540D9D42.png){width="17cm"
height="8.544cm"}** **

Using **-P **with enum4linux to get Password Policy Information

┌──(root㉿kali)-\[/home/kali\]

└─# **enum4linux -P 172.17.0.2**

OUTPUT:

![](Pictures/10000000000005B50000037041A7112A.png){width="17cm"
height="10.239cm"}** **

![](Pictures/100000000000067900000360D333FCE7.png){width="17cm"
height="8.864cm"}** **

![](Pictures/10000000000004800000036971AD64E8.png){width="17cm"
height="12.882cm"}** **

** **

Using **-a **with enum4linux to **Do all simple enumeration (-U -S -G -P
-r -o -n -i)**

┌──(root㉿kali)-\[/home/kali\]

└─# **enum4linux -a 172.17.0.2**

**OUTPUT:**

![](Pictures/10000000000005EA00000336A1A26344.png){width="17cm"
height="9.229cm"}** **

![](Pictures/10000000000005B300000387F31C795F.png){width="17cm"
height="10.522cm"}

![](Pictures/10000000000005A9000003792B591FBA.png){width="17cm"
height="10.428cm"}** **

![](Pictures/100000000000064200000362E34DD051.png){width="17cm"
height="9.188cm"}** **

## **Use Nmap to Find SMB Servers**

### **Scan the virtual networks to find potential targets.** {#scan-the-virtual-networks-to-find-potential-targets.}

One way to identify potential targets for SMB enumeration is to examine
the open ports. In an earlier lab, you used Nmap to find and enumerate
open ports on target systems. Common open ports on SMB servers are:

TCP 135 RPC

TCP 139 NetBIOS Session

TCP 389 LDAP Server

TCP 445 SMB File Service

TCP 9389 Active Directory Web Services

TCP/UDP 137 NetBIOS Name Service

UDP 138 NetBIOS Datagram

****Use the **nmap -sN **command to find the services available on hosts
in the 172.17.0.0 virtual network.****

**Note**: **sudo **is not required if you executed the **sudo su
**command above.

┌──(root㉿kali)-\[/home/kali\]

└─# **nmap -sN 172.17.0.0/24 **

**OUTPUT:**

![](Pictures/10000000000005C50000039F19FEFFF1.png){width="17cm"
height="10.67cm"}** **

****

****Take a look at the options available with smbclient using the
command **smbclient --help **command.****

┌──(root㉿kali)-\[/home/kali\]

└─# **smbclient \--help**

3.  

**OUTPUT:**

![](Pictures/10000000000004B7000002DB6ACC9F49.png){width="17cm"
height="10.296cm"}** **

![](Pictures/100000000000049A000002E671A07E3F.png){width="17cm"
height="10.709cm"}** **

****Use the ****smbclient -L** **command to list the shares on the
target host. This command produces a similar output to what the
enum4linx command ****we ****did****

****┌──****(root****㉿****kali)-\[/home/kali\]****

└─# **smbclient -L //172.17.0.2/**

****Password for \[WORKGROUPkali\]: **\<Press enter\>**

**OUTPUT:**

![](Pictures/1000000000000600000002BA55D18FC2.png){width="17cm"
height="7.724cm"}** **

****lets connect with print\$ ****

┌──(root㉿kali)-\[/home/kali\]

****└─****\# **smbclient //172.17.0.2/print\$**

**OUTPUT:**

![](Pictures/10000000000005E2000000E8722F759F.png){width="17cm"
height="2.618cm"}

****

****Connect to the **tmp **share using the **smbclient **command by
specifying the share name and IP address.****

┌──(root㉿kali)-\[/home/kali\]

└─# **smbclient //172.17.0.2/tmp**

Password for \[WORKGROUPkali\]: **\<Press enter\>**

smb: \>

Note that the prompt changed to the **smb:\> **prompt. Type **help **to
see what commands are available.

OUTPUT:

![](Pictures/10000000000003CB000000BD0F228F90.png){width="17cm"
height="3.307cm"}

Type **help **to see what commands are available.

![](Pictures/10000000000003D4000002835B5483B5.png){width="17cm"
height="11.153cm"}** **

****Enter **dir **to view the contents of the share.****

**OUTPUT:**

![](Pictures/10000000000004B30000020EDFE050BF.png){width="17cm"
height="7.431cm"}** **

## **Use smbclient to transfer files between systems**

****Smbclient is a component of Samba that can store and retrieve files,
similar to an FTP client. You will use smbclient to transfer a file to
the target system at 172.17.0.2. This simulates exploiting a network
host with malware through an SMB vulnerability.****

1.  

    Create a text file using the **cat **command. Name the file
    **virus.txt or virus.exe**. Enter the desired text. In this example,
    **This is a bad file. **was used. Be sure that you know the path to
    the file. Press **CTRL-C **to when finished.

┌──(root㉿kali)-\[/home/kali\]

└─# **cat \>\> badfile.txt**

**This is a bad file.**

Press CRTL-C to write the file.

****Upload the **virus.txt or virus.exe **to the target server using the
**put **command. The syntax for the command is:****

**put ******local-file-name****** ******remote-file-name********

smb: \> **put virus.txt or virus.exe group_work.txt**

Putting file badfile.txt as badfile.txt (19.5 kb/s) (average 19.5 kb/s)

OUTPUT:

![](Pictures/10000000000004DE000002691796D1D6.png){width="17cm"
height="8.417cm"}

7.  Verify that the file successfully uploaded using the **dir
    **command.

smb: \> **dir**

8.  ![](Pictures/10000000000004DE000002691796D1D6.png){width="17cm"
    height="8.417cm"}

    Type **quit **to exit the **smbclient **and return to the CLI
    prompt.
